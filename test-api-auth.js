const axios = require('axios');

// Test configuration
const BASE_URL = 'https://chat-294cc.cloudfunctions.net/okxChainAI';
const TEST_USER_ID = 'test_user_' + Date.now();

// Test API key (this would be generated by the system)
let testApiKey = null;

// Test functions
async function testAPIKeyGeneration() {
  console.log('ğŸ”‘ Testing API Key Generation...');
  
  try {
    const response = await axios.post(`${BASE_URL}/api/keys/generate`, {
      userId: TEST_USER_ID,
      plan: 'BASIC',
      description: 'Test API key for authentication testing'
    });
    
    if (response.data.success) {
      testApiKey = response.data.apiKey;
      console.log('âœ… API key generated successfully:', testApiKey);
      console.log('ğŸ“Š Plan details:', response.data.limits);
      return true;
    } else {
      console.log('âŒ Failed to generate API key');
      return false;
    }
  } catch (error) {
    console.error('âŒ API key generation error:', error.response?.data || error.message);
    return false;
  }
}

async function testAPIKeyInfo() {
  console.log('\nğŸ“‹ Testing API Key Info Retrieval...');
  
  if (!testApiKey) {
    console.log('âŒ No API key available for testing');
    return false;
  }
  
  try {
    const response = await axios.get(`${BASE_URL}/api/keys/${testApiKey}`);
    
    console.log('âœ… API key info retrieved successfully');
    console.log('ğŸ‘¤ User ID:', response.data.userId);
    console.log('ğŸ“Š Plan:', response.data.plan);
    console.log('ğŸ“ˆ Current usage:', response.data.currentUsage);
    return true;
  } catch (error) {
    console.error('âŒ API key info retrieval error:', error.response?.data || error.message);
    return false;
  }
}

async function testAvailablePlans() {
  console.log('\nğŸ’³ Testing Available Plans...');
  
  try {
    const response = await axios.get(`${BASE_URL}/api/plans`);
    
    console.log('âœ… Available plans retrieved successfully');
    console.log('ğŸ“Š Plans:', JSON.stringify(response.data.plans, null, 2));
    return true;
  } catch (error) {
    console.error('âŒ Plans retrieval error:', error.response?.data || error.message);
    return false;
  }
}

async function testAuthenticatedAPI() {
  console.log('\nğŸ” Testing Authenticated API Endpoints...');
  
  if (!testApiKey) {
    console.log('âŒ No API key available for testing');
    return false;
  }
  
  const headers = {
    'X-API-Key': testApiKey,
    'Content-Type': 'application/json'
  };
  
  // Test token analysis with authentication
  try {
    console.log('ğŸ§ª Testing token analysis with authentication...');
    const response = await axios.post(`${BASE_URL}/api/token/analyze`, {
      contractAddress: '0x1234567890abcdef1234567890abcdef12345678'
    }, { headers });
    
    console.log('âœ… Token analysis with authentication successful');
    console.log('ğŸ“Š Response status:', response.status);
    return true;
  } catch (error) {
    if (error.response?.status === 400) {
      console.log('âœ… Authentication successful (400 error expected for invalid address)');
      return true;
    } else {
      console.error('âŒ Token analysis with authentication failed:', error.response?.data || error.message);
      return false;
    }
  }
}

async function testUnauthenticatedAPI() {
  console.log('\nğŸš« Testing Unauthenticated API Access...');
  
  try {
    const response = await axios.post(`${BASE_URL}/api/token/analyze`, {
      contractAddress: '0x1234567890abcdef1234567890abcdef12345678'
    });
    
    console.log('âŒ API should have required authentication');
    return false;
  } catch (error) {
    if (error.response?.status === 401) {
      console.log('âœ… Unauthenticated access properly blocked (401)');
      console.log('ğŸ“ Error message:', error.response.data.message);
      return true;
    } else {
      console.error('âŒ Unexpected error for unauthenticated access:', error.response?.data || error.message);
      return false;
    }
  }
}

async function testUsageTracking() {
  console.log('\nğŸ“Š Testing Usage Tracking...');
  
  if (!testApiKey) {
    console.log('âŒ No API key available for testing');
    return false;
  }
  
  try {
    // Wait a moment for usage to be tracked
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const response = await axios.get(`${BASE_URL}/api/usage/${TEST_USER_ID}`);
    
    console.log('âœ… Usage tracking working');
    console.log('ğŸ“ˆ Total usage count:', response.data.count);
    console.log('ğŸ’° Total cost:', response.data.totalCost);
    return true;
  } catch (error) {
    console.error('âŒ Usage tracking error:', error.response?.data || error.message);
    return false;
  }
}

async function testInvalidAPIKey() {
  console.log('\nğŸ”’ Testing Invalid API Key...');
  
  const invalidHeaders = {
    'X-API-Key': 'invalid_key_123',
    'Content-Type': 'application/json'
  };
  
  try {
    const response = await axios.post(`${BASE_URL}/api/token/analyze`, {
      contractAddress: '0x1234567890abcdef1234567890abcdef12345678'
    }, { headers: invalidHeaders });
    
    console.log('âŒ Invalid API key should have been rejected');
    return false;
  } catch (error) {
    if (error.response?.status === 401) {
      console.log('âœ… Invalid API key properly rejected (401)');
      console.log('ğŸ“ Error message:', error.response.data.message);
      return true;
    } else {
      console.error('âŒ Unexpected error for invalid API key:', error.response?.data || error.message);
      return false;
    }
  }
}

// Main test runner
async function runAllTests() {
  console.log('ğŸš€ Starting API Authentication System Tests...\n');
  
  const tests = [
    { name: 'API Key Generation', fn: testAPIKeyGeneration },
    { name: 'API Key Info', fn: testAPIKeyInfo },
    { name: 'Available Plans', fn: testAvailablePlans },
    { name: 'Authenticated API Access', fn: testAuthenticatedAPI },
    { name: 'Unauthenticated API Access', fn: testUnauthenticatedAPI },
    { name: 'Usage Tracking', fn: testUsageTracking },
    { name: 'Invalid API Key Rejection', fn: testInvalidAPIKey }
  ];
  
  let passedTests = 0;
  let totalTests = tests.length;
  
  for (const test of tests) {
    try {
      const result = await test.fn();
      if (result) {
        passedTests++;
      }
    } catch (error) {
      console.error(`âŒ Test "${test.name}" failed with error:`, error.message);
    }
  }
  
  console.log('\n' + '='.repeat(50));
  console.log('ğŸ“Š TEST RESULTS SUMMARY');
  console.log('='.repeat(50));
  console.log(`âœ… Passed: ${passedTests}/${totalTests}`);
  console.log(`âŒ Failed: ${totalTests - passedTests}/${totalTests}`);
  console.log(`ğŸ“ˆ Success Rate: ${((passedTests / totalTests) * 100).toFixed(1)}%`);
  
  if (passedTests === totalTests) {
    console.log('\nğŸ‰ All tests passed! API authentication system is working correctly.');
  } else {
    console.log('\nâš ï¸  Some tests failed. Please check the implementation.');
  }
  
  if (testApiKey) {
    console.log(`\nğŸ”‘ Test API Key: ${testApiKey}`);
    console.log(`ğŸ‘¤ Test User ID: ${TEST_USER_ID}`);
    console.log('ğŸ’¡ You can use these credentials for further testing.');
  }
}

// Run tests if this file is executed directly
if (require.main === module) {
  runAllTests().catch(console.error);
}

module.exports = {
  testAPIKeyGeneration,
  testAPIKeyInfo,
  testAvailablePlans,
  testAuthenticatedAPI,
  testUnauthenticatedAPI,
  testUsageTracking,
  testInvalidAPIKey,
  runAllTests
};
